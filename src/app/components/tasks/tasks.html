<div class="task-board-container">
  <!-- Breadcrumb -->
  @if (currentProject()) {
    <div class="breadcrumb">
      <a (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Projects
      </a>
      <mat-icon>chevron_right</mat-icon>
      <span class="current">{{ currentProject()?.name }}</span>
    </div>
  }

  <div class="board-header">
    <div class="header-content">
      <h1>
        @if (currentProject()) {
          {{ currentProject()?.name }} - Tasks
        } @else {
          All Tasks
        }
      </h1>
      <p class="subtitle">Drag and drop tasks between columns</p>
    </div>
    <button mat-fab extended color="primary" (click)="onCreateTask()" [disabled]="tasksStore.tasksLoading()">
      <mat-icon>add</mat-icon>
      Add Task
    </button>
  </div>

  <!-- Error Alert -->
  @if (tasksStore.hasTasksError()) {
    <app-error-alert 
      [message]="tasksStore.tasksError() || 'Failed to load tasks'"
      (onRetry)="taskService.getTasks()"
    />
  }

  <!-- Loading State -->
  @if (tasksStore.tasksLoading()) {
    <app-loading-spinner message="Loading tasks..." />
  } @else {
    <div class="board">
      <!-- TO DO Column -->
      <div class="column">
        <div class="column-header todo">
          <mat-icon>radio_button_unchecked</mat-icon>
          <span>To Do</span>
          <span class="count">{{ todoTasks().length }}</span>
        </div>
        <div
          class="task-list"
          cdkDropList
          id="todo"
          [cdkDropListData]="todoTasks()"
          [cdkDropListConnectedTo]="['inProgress', 'completed']"
          (cdkDropListDropped)="onDrop($event, TaskStatus.TODO)"
        >
          @for (task of todoTasks(); track task.id) {
            <mat-card class="task-card" cdkDrag>
              <mat-card-header>
                <mat-card-title>{{ task.title }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (task.description) {
                <p class="description">{{ task.description }}</p>
              }
              <div class="task-meta">
                <span class="priority priority-{{ task.priority }}">
                  {{ getPriorityLabel(task.priority) }}
                </span>
                @if (task.dueDate) {
                  <span class="due-date">
                    <mat-icon>event</mat-icon>
                    {{ formatDate(task.dueDate) }}
                  </span>
                }
              </div>
            </mat-card-content>
            <mat-card-actions>
              <button mat-icon-button matTooltip="Edit" (click)="onEditTask($event, task)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Comments" (click)="onViewComments($event, task)">
                <mat-icon>comment</mat-icon>
              </button>
              <button mat-icon-button color="warn" matTooltip="Delete" (click)="onDeleteTask($event, task.id!)">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        } @empty {
          <div class="empty-column">No tasks</div>
        }
      </div>
    </div>

    <!-- IN PROGRESS Column -->
    <div class="column">
      <div class="column-header in-progress">
        <mat-icon>pending</mat-icon>
        <span>In Progress</span>
        <span class="count">{{ inProgressTasks().length }}</span>
      </div>
      <div
        class="task-list"
        cdkDropList
        id="inProgress"
        [cdkDropListData]="inProgressTasks()"
        [cdkDropListConnectedTo]="['todo', 'completed']"
        (cdkDropListDropped)="onDrop($event, TaskStatus.IN_PROGRESS)"
      >
        @for (task of inProgressTasks(); track task.id) {
          <mat-card class="task-card" cdkDrag>
            <mat-card-header>
              <mat-card-title>{{ task.title }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (task.description) {
                <p class="description">{{ task.description }}</p>
              }
              <div class="task-meta">
                <span class="priority priority-{{ task.priority }}">
                  {{ getPriorityLabel(task.priority) }}
                </span>
                @if (task.dueDate) {
                  <span class="due-date">
                    <mat-icon>event</mat-icon>
                    {{ formatDate(task.dueDate) }}
                  </span>
                }
              </div>
            </mat-card-content>
            <mat-card-actions>
              <button mat-icon-button matTooltip="Edit" (click)="onEditTask($event, task)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Comments" (click)="onViewComments($event, task)">
                <mat-icon>comment</mat-icon>
              </button>
              <button mat-icon-button color="warn" matTooltip="Delete" (click)="onDeleteTask($event, task.id!)">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        } @empty {
          <div class="empty-column">No tasks</div>
        }
      </div>
    </div>

    <!-- COMPLETED Column -->
    <div class="column">
      <div class="column-header completed">
        <mat-icon>check_circle</mat-icon>
        <span>Completed</span>
        <span class="count">{{ completedTasks().length }}</span>
      </div>
      <div
        class="task-list"
        cdkDropList
        id="completed"
        [cdkDropListData]="completedTasks()"
        [cdkDropListConnectedTo]="['todo', 'inProgress']"
        (cdkDropListDropped)="onDrop($event, TaskStatus.COMPLETED)"
      >
        @for (task of completedTasks(); track task.id) {
          <mat-card class="task-card completed-task" cdkDrag>
            <mat-card-header>
              <mat-card-title>{{ task.title }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (task.description) {
                <p class="description">{{ task.description }}</p>
              }
              <div class="task-meta">
                <span class="priority priority-{{ task.priority }}">
                  {{ getPriorityLabel(task.priority) }}
                </span>
                @if (task.dueDate) {
                  <span class="due-date">
                    <mat-icon>event</mat-icon>
                    {{ formatDate(task.dueDate) }}
                  </span>
                }
              </div>
            </mat-card-content>
            <mat-card-actions>
              <button mat-icon-button matTooltip="Edit" (click)="onEditTask($event, task)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Comments" (click)="onViewComments($event, task)">
                <mat-icon>comment</mat-icon>
              </button>
              <button mat-icon-button color="warn" matTooltip="Delete" (click)="onDeleteTask($event, task.id!)">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        } @empty {
          <div class="empty-column">No tasks</div>
        }
      </div>
    </div>
    </div>
  }
</div>